package main

import (
    {{- range .Imports }}
    "{{ . }}"
    {{- end }}
)

func main() {
    // Create a router without any middleware by default
    router := gin.New()

    {{- range .Middleware }}
    // Apply global middleware
    {{- if eq .Scope "global" }}
    router.Use(middleware.{{ .Name }}())
    {{- end }}
    {{- end }}

    // Initialize services and handlers
    {{- range .Services }}
    {{ lowerFirst .Name }} := services.New{{ .Name }}()
    {{- end }}
    {{- range .Handlers }}
    {{ lowerFirst .Name }} := handlers.New{{ .Name }}({{ lowerFirst .Service }})
    {{- end }}

    // Register routes
    {{- range .Handlers }}
    {{- $handler := . }}
    {{- range $route := .Routes }}
    // Route: {{ $route.Method }} {{ $route.Path }}
    router.{{ $route.Method }}("{{ $route.Path }}",
        {{- range $index, $mw := $route.Middleware }}
        middleware.{{ $mw }}(),
        {{- end }}
        {{ lowerFirst $handler.Name }}.{{ $route.Function }},
    )
    {{- end }}
    {{- end }}

    // Start the server
    log.Println("Starting server on :8080")
    if err := router.Run(":8080"); err != nil {
        log.Fatal(err)
    }
}